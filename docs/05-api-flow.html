<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="waQup - Voice-first ritual creation platform documentation">
    <title>API Flow</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#2563eb',
                primaryTextColor: '#ffffff',
                primaryBorderColor: 'transparent',
                lineColor: '#475569',
                secondaryColor: '#f8fafc',
                tertiaryColor: '#f1f5f9',
                background: '#ffffff',
                mainBkg: '#ffffff',
                textColor: '#1e293b',
                border1: 'transparent',
                border2: 'transparent',
                noteBkgColor: '#fef3c7',
                noteTextColor: '#78350f',
                noteBorderColor: '#f59e0b',
                actorBorder: 'transparent',
                actorBkg: '#dbeafe',
                actorTextColor: '#1e293b',
                actorLineColor: '#475569',
                signalColor: '#1e293b',
                signalTextColor: '#1e293b',
                labelBoxBkgColor: '#dbeafe',
                labelBoxBorderColor: 'transparent',
                labelTextColor: '#1e293b',
                loopTextColor: '#1e293b',
                activationBorderColor: 'transparent',
                activationBkgColor: '#dbeafe',
                sequenceNumberColor: '#ffffff',
                sectionBkgColor: '#f8fafc',
                altSectionBkgColor: '#f1f5f9',
                sectionBkgColor2: '#e2e8f0',
                excludeBkgColor: '#fee2e2',
                excludeBorderColor: 'transparent',
                critBorderColor: 'transparent',
                critBkgColor: '#fee2e2',
                doneBkgColor: '#dbeafe',
                doneBorderColor: 'transparent',
                taskBorderColor: 'transparent',
                taskBkgColor: '#dbeafe',
                taskTextLightColor: '#ffffff',
                taskTextColor: '#1e293b',
                taskTextDarkColor: '#1e293b',
                taskTextOutsideColor: '#475569',
                taskTextClickableColor: '#2563eb',
                activeTaskBorderColor: 'transparent',
                activeTaskBkgColor: '#bfdbfe',
                gridColor: '#e2e8f0',
                doneTaskBkgColor: '#dbeafe',
                doneTaskBorderColor: 'transparent',
                critBorderColor: 'transparent',
                critBkgColor: '#fee2e2',
                todayLineColor: '#dc2626',
                labelColor: '#1e293b',
                errorBkgColor: '#fee2e2',
                errorTextColor: '#991b1b'
            },
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 20
            },
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35,
                mirrorActors: true,
                bottomMarginAdj: 1,
                useMaxWidth: true,
                rightAngles: false,
                showSequenceNumbers: false
            },
            gantt: {
                titleTopMargin: 25,
                barHeight: 20,
                barGap: 4,
                topPadding: 50,
                leftPadding: 75,
                gridLineStartPadding: 35,
                fontSize: 11,
                fontFamily: 'inherit',
                numberSectionStyles: 4,
                axisFormat: '%Y-%m-%d',
                useMaxWidth: true
            }
        });
        
        // Remove borders from Mermaid diagrams after they render - ULTRA aggressive approach
        function removeMermaidBorders() {
            document.querySelectorAll('.mermaid svg').forEach(svg => {
                // Remove stroke from all rect, polygon, circle, and ellipse elements
                svg.querySelectorAll('rect, polygon, circle, ellipse').forEach(shape => {
                    // Skip if it's part of a path or line
                    const parent = shape.closest('g');
                    if (parent && (parent.classList.contains('edgePath') || parent.classList.contains('flowchart-link'))) {
                        return;
                    }
                    // Check if it's actually a shape (has fill) and not a line
                    const fill = shape.getAttribute('fill');
                    if (fill === 'none' || fill === 'transparent') {
                        // Might be a line, skip it
                        return;
                    }
                    // ULTRA aggressively remove stroke - ALL methods
                    shape.removeAttribute('stroke');
                    shape.setAttribute('stroke', 'none');
                    shape.setAttribute('stroke-width', '0');
                    shape.setAttribute('stroke-opacity', '0');
                    shape.style.stroke = 'none';
                    shape.style.strokeWidth = '0';
                    shape.style.strokeOpacity = '0';
                    shape.style.border = 'none';
                    // Force override with inline style
                    const currentStyle = shape.getAttribute('style') || '';
                    shape.setAttribute('style', currentStyle + ' stroke: none !important; stroke-width: 0 !important; stroke-opacity: 0 !important;');
                });
            });
        }
        
        // Run multiple times to catch all rendered diagrams
        function runBorderRemoval() {
            removeMermaidBorders();
            setTimeout(removeMermaidBorders, 100);
            setTimeout(removeMermaidBorders, 300);
            setTimeout(removeMermaidBorders, 500);
            setTimeout(removeMermaidBorders, 1000);
            setTimeout(removeMermaidBorders, 2000);
            setTimeout(removeMermaidBorders, 3000);
        }
        
        // Continuous border removal using requestAnimationFrame
        function continuousBorderRemoval() {
            removeMermaidBorders();
            requestAnimationFrame(continuousBorderRemoval);
        }
        
        // Start continuous removal after a short delay
        setTimeout(() => {
            // Run for 5 seconds continuously
            let count = 0;
            const interval = setInterval(() => {
                removeMermaidBorders();
                count++;
                if (count > 50) { // Stop after ~5 seconds (50 * 100ms)
                    clearInterval(interval);
                }
            }, 100);
        }, 500);
        
        // Run after Mermaid renders
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                runBorderRemoval();
            });
        } else {
            runBorderRemoval();
        }
        
        // Also use MutationObserver to catch dynamically rendered diagrams
        const observer = new MutationObserver((mutations) => {
            let shouldRun = false;
            mutations.forEach((mutation) => {
                if (mutation.addedNodes.length > 0) {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1 && (node.classList?.contains('mermaid') || node.querySelector?.('.mermaid'))) {
                            shouldRun = true;
                        }
                    });
                }
            });
            if (shouldRun) {
                removeMermaidBorders();
                setTimeout(removeMermaidBorders, 100);
                setTimeout(removeMermaidBorders, 500);
            }
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'stroke', 'stroke-width']
        });
    </script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #3b82f6;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --border-color: #e2e8f0;
            --border-radius: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-secondary);
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 0;
            margin: 0;
            padding: 0;
        }

        /* Sidebar Navigation */
        .sidebar {
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            padding: 0;
            position: sticky;
            top: 0;
            align-self: start;
            max-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .sidebar-header {
            padding: 32px 24px 24px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
            letter-spacing: -0.01em;
        }

        .sidebar-header a {
            color: var(--text-primary);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .sidebar-header a:hover {
            color: var(--primary-color);
        }

        .sidebar-header p {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin: 0;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .sidebar nav {
            flex: 1;
            padding: 16px 0;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-menu li {
            margin: 0;
            list-style: none;
        }

        .nav-menu li::before {
            display: none;
        }

        .nav-menu a {
            display: block;
            padding: 14px 24px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            position: relative;
            line-height: 1.5;
        }

        .nav-menu a:hover {
            background: var(--bg-secondary);
            color: var(--primary-color);
            border-left-color: var(--primary-color);
        }

        .nav-menu a.active {
            background: var(--bg-tertiary);
            color: var(--primary-color);
            font-weight: 600;
            border-left-color: var(--primary-color);
        }

        .nav-section {
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .nav-section-title,
        .nav-group-title {
            display: block;
            padding: 12px 24px 8px;
            font-size: 0.6875rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.12em;
            margin-top: 20px;
            margin-bottom: 6px;
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
        }

        .nav-section:first-child .nav-section-title,
        .nav-group:first-child .nav-group-title {
            margin-top: 0;
            border-top: none;
            padding-top: 8px;
        }

        .nav-group {
            margin: 0;
        }

        .nav-group-items {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-group-items li {
            margin: 0;
        }

        .nav-subgroup {
            margin: 0;
            margin-top: 8px;
        }

        .nav-subgroup-title {
            display: block;
            padding: 8px 24px 6px 32px;
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-top: 8px;
            margin-bottom: 4px;
        }

        .nav-subgroup-items {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-subgroup-items li {
            margin: 0;
        }

        .nav-subgroup-items a {
            padding-left: 40px;
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 400;
            opacity: 0.8;
        }

        .nav-subgroup-items a:hover {
            color: var(--primary-color);
            opacity: 1;
        }

        /* Archived reference styling */
        .nav-subgroup-title {
            font-style: italic;
        }

        /* Main Content */
        .main-content {
            background: var(--bg-primary);
            padding: 48px 64px;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .content-wrapper {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            color: var(--text-primary);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 16px;
            line-height: 1.2;
            letter-spacing: -0.02em;
        }

        h2 {
            color: var(--text-primary);
            font-size: 1.875rem;
            font-weight: 600;
            margin-top: 48px;
            margin-bottom: 16px;
            line-height: 1.3;
            letter-spacing: -0.01em;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }

        h3 {
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 32px;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        h4 {
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 24px;
            margin-bottom: 10px;
        }

        h5, h6 {
            color: var(--text-primary);
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 8px;
        }

        p {
            margin-bottom: 16px;
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.7;
        }

        ul, ol {
            margin-left: 0;
            margin-bottom: 24px;
            padding-left: 24px;
        }

        ul {
            list-style-type: none;
            padding-left: 0;
        }

        /* Only apply custom bullets to content lists, not navigation */
        .content-wrapper ul > li {
            position: relative;
            padding-left: 24px;
            margin-bottom: 8px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .content-wrapper ul > li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.75em;
            width: 6px;
            height: 6px;
            background: var(--primary-color);
            border-radius: 50%;
        }

        ol {
            list-style-type: decimal;
            padding-left: 24px;
        }

        ol > li {
            margin-bottom: 8px;
            color: var(--text-secondary);
            line-height: 1.7;
            padding-left: 8px;
        }

        code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Courier New', monospace;
            font-size: 0.875em;
            color: #dc2626;
            font-weight: 500;
            border: 1px solid var(--border-color);
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            margin: 24px 0;
            box-shadow: var(--shadow-md);
            border: 1px solid #334155;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        pre code {
            background: transparent;
            color: inherit;
            padding: 0;
            border: none;
            font-weight: 400;
            font-size: inherit;
        }

        /* Mermaid diagram styling */
        .mermaid-container {
            margin: 32px 0;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .mermaid {
            background: transparent;
            text-align: center;
        }
        
        /* Remove black borders from ALL Mermaid shapes */
        .mermaid svg rect[class*="node"],
        .mermaid svg rect[class*="label"],
        .mermaid svg rect[class*="flowchart"],
        .mermaid svg rect[class*="cluster"],
        .mermaid svg rect[class*="decision"],
        .mermaid svg rect[class*="actor"],
        .mermaid svg rect[class*="note"],
        .mermaid svg polygon[class*="node"],
        .mermaid svg polygon[class*="decision"],
        .mermaid svg polygon[class*="flowchart"],
        .mermaid svg .node rect,
        .mermaid svg .node polygon,
        .mermaid svg .node circle,
        .mermaid svg .node ellipse,
        .mermaid svg .flowchart-label rect,
        .mermaid svg .decision polygon,
        .mermaid svg .decision rect,
        .mermaid svg .cluster rect,
        .mermaid svg .cluster polygon,
        .mermaid svg .flowchart-node rect,
        .mermaid svg .flowchart-node polygon,
        .mermaid svg g[class*="node"] rect,
        .mermaid svg g[class*="node"] polygon,
        .mermaid svg g[class*="flowchart"] rect,
        .mermaid svg g[class*="flowchart"] polygon {
            stroke: transparent !important;
            stroke-width: 0 !important;
            border: none !important;
        }
        
        /* Target all rect and polygon elements in Mermaid diagrams */
        .mermaid svg rect:not(.edgePath rect):not(.flowchart-link rect),
        .mermaid svg polygon:not(.edgePath polygon):not(.flowchart-link polygon) {
            stroke: transparent !important;
            stroke-width: 0 !important;
        }
        
        /* Override any inline styles for shapes */
        .mermaid svg rect[stroke],
        .mermaid svg polygon[stroke],
        .mermaid svg circle[stroke],
        .mermaid svg ellipse[stroke] {
            stroke: transparent !important;
            stroke-width: 0 !important;
        }
        
        /* Target shapes by their fill attribute */
        .mermaid svg rect[fill]:not([fill="none"]):not([fill="transparent"]),
        .mermaid svg polygon[fill]:not([fill="none"]):not([fill="transparent"]),
        .mermaid svg circle[fill]:not([fill="none"]):not([fill="transparent"]),
        .mermaid svg ellipse[fill]:not([fill="none"]):not([fill="transparent"]) {
            stroke: transparent !important;
            stroke-width: 0 !important;
        }
        
        /* Universal rule: remove stroke from all rect and polygon elements */
        .mermaid svg > g > g rect,
        .mermaid svg > g > g polygon,
        .mermaid svg > g > g > g rect,
        .mermaid svg > g > g > g polygon,
        .mermaid svg g:not(.edgePath):not(.flowchart-link) rect,
        .mermaid svg g:not(.edgePath):not(.flowchart-link) polygon {
            stroke: transparent !important;
            stroke-width: 0 !important;
        }
        
        /* Final catch-all: remove borders from all shapes - ULTRA aggressive */
        .mermaid svg rect:not(.edgePath rect):not(.flowchart-link rect),
        .mermaid svg polygon:not(.edgePath polygon):not(.flowchart-link polygon),
        .mermaid svg circle:not(.edgePath circle),
        .mermaid svg ellipse:not(.edgePath ellipse) {
            stroke: none !important;
            stroke-width: 0 !important;
            stroke-opacity: 0 !important;
        }
        
        /* Target ALL shapes regardless of class or parent */
        .mermaid svg rect[fill]:not([fill="none"]):not([fill="transparent"]),
        .mermaid svg polygon[fill]:not([fill="none"]):not([fill="transparent"]),
        .mermaid svg circle[fill]:not([fill="none"]):not([fill="transparent"]),
        .mermaid svg ellipse[fill]:not([fill="none"]):not([fill="transparent"]) {
            stroke: none !important;
            stroke-width: 0 !important;
            stroke-opacity: 0 !important;
        }
        
        /* Keep lines and arrows visible */
        .mermaid svg .edgePath path,
        .mermaid svg .flowchart-link,
        .mermaid svg line,
        .mermaid svg path[marker-end],
        .mermaid svg .arrowheadPath {
            stroke: #475569 !important;
            stroke-width: 2px !important;
        }

        blockquote {
            border-left: 4px solid var(--primary-color);
            padding: 16px 20px;
            margin: 24px 0;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        blockquote p {
            margin-bottom: 0;
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 24px 0;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        th, td {
            border-bottom: 1px solid var(--border-color);
            padding: 12px 16px;
            text-align: left;
        }

        th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:nth-child(even) {
            background-color: var(--bg-secondary);
        }

        tr:hover {
            background-color: var(--bg-tertiary);
            transition: background-color 0.2s ease;
        }

        img {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius);
            margin: 24px 0;
            box-shadow: var(--shadow-md);
        }

        hr {
            border: none;
            border-top: 2px solid var(--border-color);
            margin: 40px 0;
        }

        strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        em {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Index page styles */
        .index-content {
            max-width: 1000px;
        }

        .lead {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 48px;
        }

        .documentation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 32px;
        }

        .doc-card {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            position: relative;
        }

        .doc-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .doc-card-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 4px 8px;
            background: var(--primary-color);
            color: white;
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-radius: 4px;
        }

        .doc-card h2 {
            font-size: 1.5rem;
            margin: 0 0 12px 0;
            border: none;
            padding: 0;
        }

        .doc-card h2 a {
            color: var(--text-primary);
        }

        .doc-card p {
            margin-bottom: 16px;
            font-size: 0.9375rem;
        }

        .doc-link {
            display: inline-block;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.9375rem;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Responsive design */
        @media (max-width: 968px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
                min-height: 100vh;
            }

            .sidebar {
                position: relative;
                height: auto;
                max-height: none;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .main-content {
                padding: 32px 24px;
                height: auto;
            }

            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.5rem;
            }

            .documentation-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            .main-content {
                padding: 24px 16px;
            }

            h1 {
                font-size: 1.75rem;
            }

            h2 {
                font-size: 1.25rem;
            }

            pre {
                padding: 16px;
                font-size: 0.8125rem;
            }

            .mermaid-container {
                padding: 16px;
            }
        }

        /* Print styles */
        @media print {
            .sidebar {
                display: none;
            }

            .container {
                grid-template-columns: 1fr;
            }

            .main-content {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><a href="index.html">waQup</a></h1>
                <p>Documentation</p>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-group"><span class="nav-group-title">Other</span><ul class="nav-group-items"><li><a href="waqup_product_constitution.html" class="">Product Constitution</a></li><li><a href="waqup_scientific_foundations.html" class="">Scientific Foundations</a></li><li><a href="waqup_ai_voice_and_ethics.html" class="">AI Voice & Ethics</a></li><li><a href="waqup_system_architecture.html" class="">System Architecture</a></li><li><a href="waqup_roadmap_and_releases.html" class="">Roadmap & Releases</a></li></ul></li><li class="nav-section"><span class="nav-section-title">Archived Reference</span></li><li class="nav-subgroup"><span class="nav-subgroup-title">Archived — System Architecture</span><ul class="nav-subgroup-items"><li><a href="01-architecture-overview.html" class="">Architecture Overview</a></li><li><a href="03-data-flow.html" class="">Data Flow</a></li><li><a href="05-api-flow.html" class="active">API Flow</a></li></ul></li><li class="nav-subgroup"><span class="nav-subgroup-title">Archived — User Experience</span><ul class="nav-subgroup-items"><li><a href="02-features-workflows.html" class="">Features & Workflows</a></li><li><a href="04-user-journey.html" class="">User Journey</a></li><li><a href="waqup-content-types-and-taxonomy.html" class="">Content Types & Taxonomy</a></li></ul></li><li class="nav-subgroup"><span class="nav-subgroup-title">Archived — Business</span><ul class="nav-subgroup-items"><li><a href="waqup-credits-system.html" class="">Credits System</a></li></ul></li><li class="nav-subgroup"><span class="nav-subgroup-title">Archived — Planning</span><ul class="nav-subgroup-items"><li><a href="06-development-timeline.html" class="">Development Timeline & Roadmap</a></li></ul></li><li class="nav-subgroup"><span class="nav-subgroup-title">Other</span><ul class="nav-subgroup-items"><li><a href="ai-voice-and-ethics.html" class="">AI Voice & Ethics</a></li><li><a href="api-flow-archived.html" class="">API Flow</a></li><li><a href="architecture-overview-archived.html" class="">Architecture Overview</a></li><li><a href="content-types-and-taxonomy-archived.html" class="">Content Types & Taxonomy</a></li><li><a href="conversational-and-ritual-system.html" class="">Conversational & Ritual System</a></li><li><a href="credits-system-archived.html" class="">Credits System</a></li><li><a href="data-flow-archived.html" class="">Data Flow</a></li><li><a href="development-timeline-archived.html" class="">Development Timeline & Roadmap</a></li><li><a href="features-workflows-archived.html" class="">Features & Workflows</a></li><li><a href="product-constitution.html" class="">Product Constitution</a></li><li><a href="roadmap-and-releases.html" class="">Roadmap & Releases</a></li><li><a href="scientific-foundations.html" class="">Scientific Foundations</a></li><li><a href="system-architecture.html" class="">System Architecture</a></li><li><a href="user-journey-archived.html" class="">User Journey</a></li><li><a href="value-and-growth-economy.html" class="">Value & Growth Economy</a></li></ul></li>
                </ul>
            </nav>
        </aside>
        <main class="main-content">
            <div class="content-wrapper">
                <h1>API Flow</h1>
<blockquote>
<p><strong>⚠️ Archived Reference Document</strong><br>
This document is kept for historical reference. The complete, up-to-date content has been merged into the <strong><a href="./waqup_system_architecture.html#api-flow">System Architecture</a></strong> document.</p>
</blockquote>
<p><strong>Domain</strong>: HOW waQup’s APIs work (endpoints, flows, design principles)</p>
<hr>
<p><strong>Related SSOT Documents</strong>:</p>
<ul>
<li>Content Types &amp; Taxonomy: Content type definitions and API filtering</li>
<li>Architecture Overview: System architecture and service design (complementary)</li>
<li>Credits System: Credit API endpoints and consumption flows</li>
<li>Data Flow: Data movement patterns through APIs</li>
</ul>
<h2>API Architecture Overview</h2>
<p>waQup uses a RESTful API architecture with WebSocket support for real-time conversation flows. All APIs are versioned, authenticated via JWT, and follow consistent patterns for error handling, rate limiting, and response formatting.</p>
<h2>API Gateway Flow</h2>
<div class="mermaid-container"><pre class="mermaid">sequenceDiagram
    participant Client
    participant API Gateway
    participant Auth Service
    participant Rate Limiter
    participant Service
    participant Database

    Client->>API Gateway: API Request + JWT Token
    API Gateway->>Auth Service: Validate Token
    Auth Service-->>API Gateway: Token Valid/Invalid
    alt Token Invalid
        API Gateway-->>Client: 401 Unauthorized
    else Token Valid
        API Gateway->>Rate Limiter: Check Rate Limit
        Rate Limiter-->>API Gateway: Limit OK/Exceeded
        alt Rate Limit Exceeded
            API Gateway-->>Client: 429 Too Many Requests
        else Rate Limit OK
            API Gateway->>Service: Route Request
            Service->>Database: Query/Update Data
            Database-->>Service: Return Data
            Service-->>API Gateway: Response
            API Gateway-->>Client: JSON Response
        end
    end
</pre></div>
<h2>Core API Endpoints</h2>
<h3>Authentication APIs</h3>
<p><strong>POST /api/v1/auth/register</strong></p>
<pre><code class="language-json">Request:
{
  &quot;email&quot;: &quot;user@example.com&quot;,
  &quot;password&quot;: &quot;securepassword&quot;
}

Response:
{
  &quot;token&quot;: &quot;jwt_token_here&quot;,
  &quot;refresh_token&quot;: &quot;refresh_token_here&quot;,
  &quot;user&quot;: {
    &quot;id&quot;: &quot;uuid&quot;,
    &quot;email&quot;: &quot;user@example.com&quot;
  }
}
</code></pre>
<p><strong>POST /api/v1/auth/login</strong></p>
<pre><code class="language-json">Request:
{
  &quot;email&quot;: &quot;user@example.com&quot;,
  &quot;password&quot;: &quot;securepassword&quot;
}

Response:
{
  &quot;token&quot;: &quot;jwt_token_here&quot;,
  &quot;refresh_token&quot;: &quot;refresh_token_here&quot;,
  &quot;user&quot;: {
    &quot;id&quot;: &quot;uuid&quot;,
    &quot;email&quot;: &quot;user@example.com&quot;
  }
}
</code></pre>
<p><strong>POST /api/v1/auth/refresh</strong></p>
<pre><code class="language-json">Request:
{
  &quot;refresh_token&quot;: &quot;refresh_token_here&quot;
}

Response:
{
  &quot;token&quot;: &quot;new_jwt_token_here&quot;
}
</code></pre>
<h3>Conversation APIs</h3>
<p><strong>WebSocket: /ws/conversation</strong></p>
<pre><code class="language-javascript">// Connect
ws://api.waqup.com/ws/conversation?token=jwt_token

// Send message
{
  &quot;type&quot;: &quot;message&quot;,
  &quot;content&quot;: &quot;I need something to help me sleep&quot;,
  &quot;session_id&quot;: &quot;session_uuid&quot;
}

// Receive response
{
  &quot;type&quot;: &quot;response&quot;,
  &quot;content&quot;: &quot;I'd be happy to help you create a ritual for sleep...&quot;,
  &quot;state&quot;: &quot;IntentDiscovery&quot;,
  &quot;session_id&quot;: &quot;session_uuid&quot;
}
</code></pre>
<p><strong>POST /api/v1/conversation/start</strong></p>
<pre><code class="language-json">Request:
{
  &quot;content_type&quot;: &quot;affirmation&quot; | &quot;guided_meditation&quot; | &quot;ritual&quot;,
  &quot;intent&quot;: &quot;sleep&quot; // optional, can be discovered through conversation
}

Response:
{
  &quot;session_id&quot;: &quot;uuid&quot;,
  &quot;content_type&quot;: &quot;ritual&quot;,
  &quot;state&quot;: &quot;Greeting&quot;,
  &quot;message&quot;: &quot;Hello! I'd be happy to help you create a personalized ritual...&quot;
}
</code></pre>
<p><strong>POST /api/v1/conversation/message</strong></p>
<pre><code class="language-json">Request:
{
  &quot;session_id&quot;: &quot;uuid&quot;,
  &quot;message&quot;: &quot;I want something calming for evening&quot;
}

Response:
{
  &quot;session_id&quot;: &quot;uuid&quot;,
  &quot;state&quot;: &quot;ContextGathering&quot;,
  &quot;response&quot;: &quot;That sounds wonderful. When would you like to practice this?&quot;,
  &quot;context&quot;: {
    &quot;intent&quot;: &quot;calming&quot;,
    &quot;time_preference&quot;: null
  }
}
</code></pre>
<p><strong>GET /api/v1/conversation/state</strong></p>
<pre><code class="language-json">Response:
{
  &quot;session_id&quot;: &quot;uuid&quot;,
  &quot;state&quot;: &quot;PracticeDetails&quot;,
  &quot;context&quot;: {
    &quot;intent&quot;: &quot;calming&quot;,
    &quot;time_preference&quot;: &quot;evening&quot;,
    &quot;duration&quot;: &quot;10 minutes&quot;
  },
  &quot;messages&quot;: [...]
}
</code></pre>
<p><strong>POST /api/v1/conversation/complete</strong></p>
<pre><code class="language-json">Request:
{
  &quot;session_id&quot;: &quot;uuid&quot;,
  &quot;confirm&quot;: true
}

Response:
{
  &quot;ritual_id&quot;: &quot;uuid&quot;,
  &quot;status&quot;: &quot;generating&quot;,
  &quot;estimated_time&quot;: 30 // seconds
}
</code></pre>
<h3>Content APIs (Affirmations, Guided Meditations, Rituals)</h3>
<p><strong>GET /api/v1/content</strong></p>
<pre><code class="language-json">Query Parameters:
- content_type: &quot;affirmation&quot; | &quot;guided_meditation&quot; | &quot;ritual&quot; | null (all)
- page: number (default: 1)
- limit: number (default: 20)
- tags: string[] (optional)
- depth: &quot;shallow&quot; | &quot;medium&quot; | &quot;deep&quot; | null (all)

Response:
{
  &quot;content_items&quot;: [
    {
      &quot;id&quot;: &quot;uuid&quot;,
      &quot;content_type&quot;: &quot;ritual&quot;,
      &quot;title&quot;: &quot;Evening Calm&quot;,
      &quot;depth&quot;: &quot;deep&quot;,
      &quot;duration&quot;: 600,
      &quot;tags&quot;: [&quot;evening&quot;, &quot;calming&quot;],
      &quot;created_at&quot;: &quot;2024-01-01T00:00:00Z&quot;,
      &quot;last_played_at&quot;: &quot;2024-01-15T10:30:00Z&quot;,
      &quot;play_count&quot;: 12
    }
  ],
  &quot;pagination&quot;: {
    &quot;page&quot;: 1,
    &quot;limit&quot;: 20,
    &quot;total&quot;: 45,
    &quot;pages&quot;: 3
  }
}
</code></pre>
<p><strong>GET /api/v1/content/{id}</strong></p>
<pre><code class="language-json">Response:
{
  &quot;id&quot;: &quot;uuid&quot;,
  &quot;content_type&quot;: &quot;ritual&quot;,
  &quot;title&quot;: &quot;Evening Calm&quot;,
  &quot;content_text&quot;: &quot;Find a comfortable position...&quot;,
  &quot;depth&quot;: &quot;deep&quot;,
  &quot;duration&quot;: 600,
  &quot;tags&quot;: [&quot;calming&quot;, &quot;evening&quot;, &quot;breath&quot;],
  &quot;voice&quot;: {
    &quot;id&quot;: &quot;uuid&quot;,
    &quot;name&quot;: &quot;Calm Guide&quot;
  },
  &quot;audio_url&quot;: &quot;https://cdn.waqup.com/audio/...&quot;,
  &quot;created_at&quot;: &quot;2024-01-01T00:00:00Z&quot;,
  &quot;structure&quot;: {...},
  &quot;context&quot;: {...}
}
</code></pre>
<p><strong>POST /api/v1/content/{id}/play</strong></p>
<pre><code class="language-json">Request:
{
  &quot;started_at&quot;: &quot;2024-01-15T10:30:00Z&quot;
}

Response:
{
  &quot;practice_event_id&quot;: &quot;uuid&quot;,
  &quot;status&quot;: &quot;started&quot;
}
</code></pre>
<p><strong>POST /api/v1/content/{id}/complete</strong></p>
<pre><code class="language-json">Request:
{
  &quot;practice_event_id&quot;: &quot;uuid&quot;,
  &quot;completed_at&quot;: &quot;2024-01-15T10:40:00Z&quot;,
  &quot;duration&quot;: 600
}

Response:
{
  &quot;practice_event_id&quot;: &quot;uuid&quot;,
  &quot;status&quot;: &quot;completed&quot;
}
</code></pre>
<p><strong>DELETE /api/v1/content/{id}</strong></p>
<pre><code class="language-json">Response:
{
  &quot;status&quot;: &quot;deleted&quot;,
  &quot;content_item_id&quot;: &quot;uuid&quot;
}
</code></pre>
<p><strong>GET /api/v1/content/{id}/export</strong></p>
<pre><code class="language-json">Query Parameters:
- format: &quot;text&quot; | &quot;audio&quot; | &quot;both&quot;

Response:
{
  &quot;text&quot;: &quot;Find a comfortable position...&quot;,
  &quot;audio_url&quot;: &quot;https://cdn.waqup.com/audio/...&quot;,
  &quot;exported_at&quot;: &quot;2024-01-15T10:45:00Z&quot;
}
</code></pre>
<h3>Marketplace APIs</h3>
<p><strong>GET /api/v1/catalog/packs</strong></p>
<pre><code class="language-json">Query Parameters:
- page: number
- limit: number
- search: string
- tags: string[]
- creator_id: uuid
- price_type: &quot;free&quot; | &quot;one_time&quot; | &quot;subscription&quot;

Response:
{
  &quot;packs&quot;: [
    {
      &quot;id&quot;: &quot;uuid&quot;,
      &quot;title&quot;: &quot;Morning Energy Pack&quot;,
      &quot;description&quot;: &quot;Start your day with intention...&quot;,
      &quot;creator&quot;: {
        &quot;id&quot;: &quot;uuid&quot;,
        &quot;name&quot;: &quot;Sarah Facilitator&quot;
      },
      &quot;price_type&quot;: &quot;subscription&quot;,
      &quot;price_amount&quot;: 9.99,
      &quot;subscription_interval&quot;: &quot;monthly&quot;,
      &quot;ritual_count&quot;: 5,
      &quot;rating&quot;: 4.8,
      &quot;review_count&quot;: 127
    }
  ],
  &quot;pagination&quot;: {...}
}
</code></pre>
<p><strong>GET /api/v1/catalog/packs/{id}</strong></p>
<pre><code class="language-json">Response:
{
  &quot;id&quot;: &quot;uuid&quot;,
  &quot;title&quot;: &quot;Morning Energy Pack&quot;,
  &quot;description&quot;: &quot;Start your day with intention...&quot;,
  &quot;creator&quot;: {...},
  &quot;rituals&quot;: [
    {
      &quot;id&quot;: &quot;uuid&quot;,
      &quot;title&quot;: &quot;Sunrise Breath&quot;,
      &quot;duration&quot;: 300,
      &quot;practice_type&quot;: &quot;breath_work&quot;
    }
  ],
  &quot;price_type&quot;: &quot;subscription&quot;,
  &quot;price_amount&quot;: 9.99,
  &quot;user_has_access&quot;: false
}
</code></pre>
<p><strong>GET /api/v1/catalog/recommendations</strong></p>
<pre><code class="language-json">Response:
{
  &quot;recommendations&quot;: [
    {
      &quot;pack_id&quot;: &quot;uuid&quot;,
      &quot;reason&quot;: &quot;Based on your practice history&quot;,
      &quot;score&quot;: 0.85
    }
  ]
}
</code></pre>
<p><strong>POST /api/v1/payments/checkout</strong></p>
<pre><code class="language-json">Request:
{
  &quot;pack_id&quot;: &quot;uuid&quot;,
  &quot;price_type&quot;: &quot;subscription&quot;,
  &quot;success_url&quot;: &quot;https://app.waqup.com/success&quot;,
  &quot;cancel_url&quot;: &quot;https://app.waqup.com/cancel&quot;
}

Response:
{
  &quot;checkout_url&quot;: &quot;https://checkout.stripe.com/...&quot;,
  &quot;session_id&quot;: &quot;stripe_session_id&quot;
}
</code></pre>
<p><strong>POST /api/v1/payments/webhook</strong></p>
<pre><code class="language-json">// Stripe webhook handler (internal)
Request:
{
  &quot;type&quot;: &quot;checkout.session.completed&quot;,
  &quot;data&quot;: {
    &quot;object&quot;: {
      &quot;id&quot;: &quot;stripe_session_id&quot;,
      &quot;metadata&quot;: {
        &quot;pack_id&quot;: &quot;uuid&quot;,
        &quot;user_id&quot;: &quot;uuid&quot;
      }
    }
  }
}
</code></pre>
<h3>User APIs</h3>
<p><strong>GET /api/v1/users/me</strong></p>
<pre><code class="language-json">Response:
{
  &quot;id&quot;: &quot;uuid&quot;,
  &quot;email&quot;: &quot;user@example.com&quot;,
  &quot;preferences&quot;: {
    &quot;voice_id&quot;: &quot;uuid&quot;,
    &quot;pace&quot;: &quot;moderate&quot;,
    &quot;tone&quot;: &quot;warm&quot;
  },
  &quot;created_at&quot;: &quot;2024-01-01T00:00:00Z&quot;
}
</code></pre>
<p><strong>PUT /api/v1/users/me</strong></p>
<pre><code class="language-json">Request:
{
  &quot;preferences&quot;: {
    &quot;voice_id&quot;: &quot;new_voice_id&quot;,
    &quot;pace&quot;: &quot;slower&quot;
  }
}

Response:
{
  &quot;id&quot;: &quot;uuid&quot;,
  &quot;preferences&quot;: {
    &quot;voice_id&quot;: &quot;new_voice_id&quot;,
    &quot;pace&quot;: &quot;slower&quot;,
    &quot;tone&quot;: &quot;warm&quot;
  }
}
</code></pre>
<p><strong>GET /api/v1/users/me/history</strong></p>
<pre><code class="language-json">Query Parameters:
- page: number
- limit: number
- ritual_id: uuid (optional)

Response:
{
  &quot;practice_events&quot;: [
    {
      &quot;id&quot;: &quot;uuid&quot;,
      &quot;ritual_id&quot;: &quot;uuid&quot;,
      &quot;ritual_title&quot;: &quot;Evening Calm&quot;,
      &quot;started_at&quot;: &quot;2024-01-15T10:30:00Z&quot;,
      &quot;completed_at&quot;: &quot;2024-01-15T10:40:00Z&quot;,
      &quot;duration&quot;: 600
    }
  ],
  &quot;pagination&quot;: {...}
}
</code></pre>
<h3>Credit APIs</h3>
<p><strong>GET /api/v1/credits/balance</strong></p>
<pre><code class="language-json">Response:
{
  &quot;balance&quot;: 5,
  &quot;free_tier_used&quot;: true,
  &quot;last_transaction_at&quot;: &quot;2024-01-15T10:30:00Z&quot;
}
</code></pre>
<p><strong>GET /api/v1/credits/transactions</strong></p>
<pre><code class="language-json">Query Parameters:
- page: number
- limit: number
- transaction_type: &quot;purchase&quot; | &quot;consumption&quot; | &quot;refund&quot; (optional)

Response:
{
  &quot;transactions&quot;: [
    {
      &quot;id&quot;: &quot;uuid&quot;,
      &quot;type&quot;: &quot;consumption&quot;,
      &quot;amount&quot;: -1,
      &quot;balance_after&quot;: 4,
      &quot;ritual_id&quot;: &quot;uuid&quot;,
      &quot;created_at&quot;: &quot;2024-01-15T10:30:00Z&quot;
    },
    {
      &quot;id&quot;: &quot;uuid&quot;,
      &quot;type&quot;: &quot;purchase&quot;,
      &quot;amount&quot;: 10,
      &quot;balance_after&quot;: 11,
      &quot;pack_id&quot;: &quot;seeker&quot;,
      &quot;created_at&quot;: &quot;2024-01-10T08:00:00Z&quot;
    }
  ],
  &quot;pagination&quot;: {...}
}
</code></pre>
<p><strong>POST /api/v1/credits/purchase</strong></p>
<pre><code class="language-json">Request:
{
  &quot;pack_type&quot;: &quot;starter&quot; | &quot;seeker&quot; | &quot;architect&quot;,
  &quot;success_url&quot;: &quot;https://app.waqup.com/success&quot;,
  &quot;cancel_url&quot;: &quot;https://app.waqup.com/cancel&quot;
}

Response:
{
  &quot;checkout_url&quot;: &quot;https://checkout.stripe.com/...&quot;,
  &quot;session_id&quot;: &quot;stripe_session_id&quot;,
  &quot;credits_amount&quot;: 3
}
</code></pre>
<p><strong>POST /api/v1/credits/check</strong></p>
<pre><code class="language-json">Request:
{
  &quot;action&quot;: &quot;ritual_creation&quot;,
  &quot;ritual_id&quot;: &quot;uuid&quot; // optional, for modifications
}

Response:
{
  &quot;sufficient&quot;: true,
  &quot;balance&quot;: 5,
  &quot;required&quot;: 1,
  &quot;message&quot;: &quot;You have sufficient credits&quot;
}
</code></pre>
<h2>API Flow Diagrams</h2>
<h3>Ritual Creation Flow</h3>
<div class="mermaid-container"><pre class="mermaid">sequenceDiagram
    participant Client
    participant API Gateway
    participant Conversation Service
    participant Ritual Gen Service
    participant LLM
    participant Audio Gen Service
    participant TTS
    participant Database

    Client->>API Gateway: POST /conversation/start (with content_type)
    API Gateway->>Conversation Service: Create session
    Conversation Service->>Database: Store session state + content_type
    Conversation Service-->>Client: Session ID + Greeting (type-specific)

    Client->>API Gateway: POST /conversation/message
    API Gateway->>Conversation Service: Process message
    Conversation Service->>Database: Update session state
    Conversation Service-->>Client: Response + Next question

    Note over Client,Conversation Service: Repeat until ritual confirmed

    Client->>API Gateway: POST /conversation/complete
    API Gateway->>Conversation Service: Finalize ritual
    Conversation Service->>Credit Service: Check credit balance
    Credit Service-->>Conversation Service: Credit available
    Conversation Service->>Ritual Gen Service: Generate ritual
    Ritual Gen Service->>LLM: Generate text
    LLM-->>Ritual Gen Service: Ritual text
    Ritual Gen Service->>Database: Store ritual text
    Ritual Gen Service->>Audio Gen Service: Generate audio
    Audio Gen Service->>TTS: Synthesize voice
    TTS-->>Audio Gen Service: Audio file
    Audio Gen Service->>Database: Store audio URL
    Audio Gen Service->>Credit Service: Consume credit (on success)
    Credit Service-->>Audio Gen Service: Credit consumed
    Audio Gen Service-->>Ritual Gen Service: Audio ready
    Ritual Gen Service-->>Conversation Service: Ritual complete
    Conversation Service-->>Client: Ritual ID + Status
</pre></div>
<h3>Ritual Playback Flow</h3>
<div class="mermaid-container"><pre class="mermaid">sequenceDiagram
    participant Client
    participant API Gateway
    participant Ritual Library Service
    participant Cache
    participant Database
    participant CDN

    Client->>API Gateway: GET /content/{id}
    API Gateway->>Ritual Library Service: Get content item
    Ritual Library Service->>Cache: Check cache
    alt Cache Hit
        Cache-->>Ritual Library Service: Cached data
    else Cache Miss
        Ritual Library Service->>Database: Query ritual
        Database-->>Ritual Library Service: Ritual data
        Ritual Library Service->>Cache: Store in cache
    end
    Ritual Library Service->>CDN: Generate pre-signed URL
    CDN-->>Ritual Library Service: Audio URL
    Ritual Library Service-->>Client: Ritual + Audio URL

    Client->>API Gateway: POST /content/{id}/play
    API Gateway->>Ritual Library Service: Record play event
    Ritual Library Service->>Database: Store practice event (with content_type)
    Ritual Library Service-->>Client: Practice started

    Client->>CDN: Stream audio
    CDN-->>Client: Audio stream

    Client->>API Gateway: POST /content/{id}/complete
    API Gateway->>Ritual Library Service: Complete practice
    Ritual Library Service->>Database: Update practice event
    Ritual Library Service-->>Client: Practice completed
</pre></div>
<h3>Marketplace Purchase Flow</h3>
<div class="mermaid-container"><pre class="mermaid">sequenceDiagram
    participant Client
    participant API Gateway
    participant Catalog Service
    participant Payment Service
    participant Stripe
    participant Database
    participant Ritual Library Service

    Client->>API Gateway: GET /catalog/packs/{id}
    API Gateway->>Catalog Service: Get pack details
    Catalog Service->>Database: Query pack
    Database-->>Catalog Service: Pack data
    Catalog Service-->>Client: Pack details

    Client->>API Gateway: POST /payments/checkout
    API Gateway->>Payment Service: Create checkout
    Payment Service->>Stripe: Create checkout session
    Stripe-->>Payment Service: Checkout URL
    Payment Service-->>Client: Redirect to Stripe

    Client->>Stripe: Complete payment
    Stripe->>Payment Service: Webhook (payment success)
    Payment Service->>Database: Record purchase
    Payment Service->>Ritual Library Service: Grant access
    Ritual Library Service->>Database: Link pack to user
    Payment Service-->>Stripe: Webhook acknowledged

    Client->>API Gateway: GET /catalog/packs/{id}
    API Gateway->>Catalog Service: Get pack
    Catalog Service->>Database: Query pack + access
    Database-->>Catalog Service: Pack + user_has_access: true
    Catalog Service-->>Client: Pack with access granted
</pre></div>
<h2>API Design Principles</h2>
<h3>RESTful Design</h3>
<ul>
<li>Standard HTTP methods (GET, POST, PUT, DELETE)</li>
<li>Resource-based URLs (<code>/rituals/{id}</code>)</li>
<li>Consistent response formats</li>
<li>Proper HTTP status codes</li>
</ul>
<h3>Versioning</h3>
<ul>
<li>URL-based versioning (<code>/api/v1/...</code>)</li>
<li>Backward compatibility maintained</li>
<li>Deprecation notices for old versions</li>
</ul>
<h3>Authentication</h3>
<ul>
<li>JWT tokens for stateless auth</li>
<li>Refresh token rotation</li>
<li>Token expiration (15 minutes access, 7 days refresh)</li>
</ul>
<h3>Rate Limiting</h3>
<ul>
<li>Per-user rate limits</li>
<li>Tiered limits (free vs. paid users)</li>
<li>429 status code with retry-after header</li>
</ul>
<h3>Error Handling</h3>
<pre><code class="language-json">{
  &quot;error&quot;: {
    &quot;code&quot;: &quot;RITUAL_NOT_FOUND&quot;,
    &quot;message&quot;: &quot;Ritual with ID {id} not found&quot;,
    &quot;details&quot;: {...}
  }
}
</code></pre>
<h3>Pagination</h3>
<pre><code class="language-json">{
  &quot;data&quot;: [...],
  &quot;pagination&quot;: {
    &quot;page&quot;: 1,
    &quot;limit&quot;: 20,
    &quot;total&quot;: 100,
    &quot;pages&quot;: 5,
    &quot;has_next&quot;: true,
    &quot;has_prev&quot;: false
  }
}
</code></pre>
<h2>API Performance</h2>
<h3>Caching Strategy</h3>
<ul>
<li>Redis cache for frequently accessed data</li>
<li>Cache TTL: 15 minutes (user profiles), 1 hour (ritual metadata)</li>
<li>CDN cache for audio files (long TTL)</li>
</ul>
<h3>Async Processing</h3>
<ul>
<li>Audio generation via message queue</li>
<li>LLM calls can be async for non-real-time flows</li>
<li>Webhook processing async</li>
</ul>
<h3>Response Times</h3>
<ul>
<li>API responses: &lt; 200ms (p95)</li>
<li>Audio generation: &lt; 30s (async)</li>
<li>Ritual generation: &lt; 10s (LLM call)</li>
</ul>
<h2>API Security</h2>
<h3>Input Validation</h3>
<ul>
<li>Schema validation for all requests</li>
<li>SQL injection prevention</li>
<li>XSS prevention</li>
<li>Rate limiting</li>
</ul>
<h3>Data Protection</h3>
<ul>
<li>No sensitive data in URLs</li>
<li>Pre-signed URLs for audio (time-limited)</li>
<li>Encryption at rest and in transit</li>
<li>GDPR compliance</li>
</ul>
<h3>Monitoring</h3>
<ul>
<li>Request logging (structured JSON)</li>
<li>Error tracking</li>
<li>Performance monitoring</li>
<li>Security event logging</li>
</ul>

            </div>
        </main>
    </div>
</body>
</html>
